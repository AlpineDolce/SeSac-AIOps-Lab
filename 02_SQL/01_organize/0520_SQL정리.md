# ğŸ›¢ï¸ SQL ì‹¬í™”: ì„œë¸Œì¿¼ë¦¬, í•¨ìˆ˜, í”„ë¡œì‹œì €, íŠ¸ë¦¬ê±° (Day 18)

> **ì´ ë¬¸ì„œì˜ ëª©ì **: ì´ ë¬¸ì„œëŠ” ë¶€íŠ¸ìº í”„ 21ì¼ì°¨ì— í•™ìŠµí•œ SQLì˜ í•µì‹¬ ì‹¬í™” ê¸°ë²•ë“¤ì„ ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬í•œ ìë£Œì…ë‹ˆë‹¤. **ìƒê´€ ì„œë¸Œì¿¼ë¦¬, CTE, `CASE` ë¬¸, ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜, ì €ì¥ í”„ë¡œì‹œì €, íŠ¸ë¦¬ê±°** ë“± ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ êµ¬í˜„í•˜ê³  ê´€ë¦¬í•˜ëŠ” ëŠ¥ë ¥ì„ ë³´ì—¬ì£¼ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.

---

## ğŸ“š ëª©ì°¨

1.  [**ì„œë¸Œì¿¼ë¦¬ ì‹¬í™”: ë°ì´í„° ì¶”ì¶œì˜ ê³ ê¸‰ ê¸°ë²•**](#1-ì„œë¸Œì¿¼ë¦¬-ì‹¬í™”-ë°ì´í„°-ì¶”ì¶œì˜-ê³ ê¸‰-ê¸°ë²•)
    -   [1.1. ìƒê´€ ì„œë¸Œì¿¼ë¦¬: ì™¸ë¶€ ì¿¼ë¦¬ì™€ì˜ ì—°ë™](#11-ìƒê´€-ì„œë¸Œì¿¼ë¦¬-ì™¸ë¶€-ì¿¼ë¦¬ì™€ì˜-ì—°ë™)
        -   [1.1.1. `EXISTS`ì™€ `NOT EXISTS` í™œìš©](#111-existsì™€-not-exists-í™œìš©)
        -   [1.1.2. ë¹„êµ ë¶„ì„ìš© ìƒê´€ ì„œë¸Œì¿¼ë¦¬](#112-ë¹„êµ-ë¶„ì„ìš©-ìƒê´€-ì„œë¸Œì¿¼ë¦¬)
    -   [1.2. ë‹¤ì¤‘ ë ˆë²¨ ì„œë¸Œì¿¼ë¦¬: ì¤‘ì²©ëœ ì¿¼ë¦¬ì˜ í˜](#12-ë‹¤ì¤‘-ë ˆë²¨-ì„œë¸Œì¿¼ë¦¬-ì¤‘ì²©ëœ-ì¿¼ë¦¬ì˜-í˜)
    -   [1.3. CTE (Common Table Expression): ì¿¼ë¦¬ ê°€ë…ì„± í–¥ìƒ](#13-cte-common-table-expression-ì¿¼ë¦¬-ê°€ë…ì„±-í–¥ìƒ)
2.  [**`CASE` ë¬¸: ì¡°ê±´ë¶€ ë¡œì§ì˜ êµ¬í˜„**](#2-case-ë¬¸-ì¡°ê±´ë¶€-ë¡œì§ì˜-êµ¬í˜„)
    -   [2.1. `CASE` ë¬¸ì˜ ê¸°ë³¸: ë‹¨ìˆœ vs ê²€ìƒ‰](#21-case-ë¬¸ì˜-ê¸°ë³¸-ë‹¨ìˆœ-vs-ê²€ìƒ‰)
        -   [2.1.1. ë‹¨ìˆœ `CASE` (ê°’ ë¹„êµ)](#211-ë‹¨ìˆœ-case-ê°’-ë¹„êµ)
        -   [2.1.2. ê²€ìƒ‰ `CASE` (ì¡°ê±´ ë¹„êµ)](#212-ê²€ìƒ‰-case-ì¡°ê±´-ë¹„êµ)
    -   [2.2. ì¤‘ì²© `CASE`ì™€ ë³µí•© ì¡°ê±´: ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§](#22-ì¤‘ì²©-caseì™€-ë³µí•©-ì¡°ê±´-ë³µì¡í•œ-ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§)
    -   [2.3. `CASE` ë¬¸ì„ í™œìš©í•œ í”¼ë²— í…Œì´ë¸”: ë°ì´í„° ì¬êµ¬ì„±](#23-case-ë¬¸ì„-í™œìš©í•œ-í”¼ë²—-í…Œì´ë¸”-ë°ì´í„°-ì¬êµ¬ì„±)
3.  [**ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ (UDF): ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ë¡œì§**](#3-ì‚¬ìš©ì-ì •ì˜-í•¨ìˆ˜-udf-ì¬ì‚¬ìš©-ê°€ëŠ¥í•œ-ë¡œì§)
    -   [3.1. í•¨ìˆ˜ ìƒì„± ê¸°ì´ˆ: ê°„ë‹¨í•œ í•¨ìˆ˜ ë§Œë“¤ê¸°](#31-í•¨ìˆ˜-ìƒì„±-ê¸°ì´ˆ-ê°„ë‹¨í•œ-í•¨ìˆ˜-ë§Œë“¤ê¸°)
    -   [3.2. ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í•¨ìˆ˜: ì¢…í•© í‰ê°€ í•¨ìˆ˜](#32-ë³µì¡í•œ-ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§-í•¨ìˆ˜-ì¢…í•©-í‰ê°€-í•¨ìˆ˜)
4.  [**ì €ì¥ í”„ë¡œì‹œì € (Stored Procedure): ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìº¡ìŠí™”**](#4-ì €ì¥-í”„ë¡œì‹œì €-stored-procedure-ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§-ìº¡ìŠí™”)
    -   [4.1. ê¸°ë³¸ ì €ì¥ í”„ë¡œì‹œì €: ë§¤ê°œë³€ìˆ˜ í™œìš©](#41-ê¸°ë³¸-ì €ì¥-í”„ë¡œì‹œì €-ë§¤ê°œë³€ìˆ˜-í™œìš©)
    -   [4.2. ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í”„ë¡œì‹œì €: ì„±ê³¼ í‰ê°€ ë° ë³´ìƒ](#42-ë³µì¡í•œ-ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§-í”„ë¡œì‹œì €-ì„±ê³¼-í‰ê°€-ë°-ë³´ìƒ)
    -   [4.3. í”„ë¡œì íŠ¸ ê´€ë¦¬ í”„ë¡œì‹œì €: í”„ë¡œì íŠ¸ ë°°ì • ìë™í™”](#43-í”„ë¡œì íŠ¸-ê´€ë¦¬-í”„ë¡œì‹œì €-í”„ë¡œì íŠ¸-ë°°ì •-ìë™í™”)
5.  [**íŠ¸ë¦¬ê±° (Trigger): ë°ì´í„° ë³€ê²½ ìë™í™”**](#5-íŠ¸ë¦¬ê±°-trigger-ë°ì´í„°-ë³€ê²½-ìë™í™”)
    -   [5.1. ê¸°ë³¸ íŠ¸ë¦¬ê±° ìƒì„±: ìë™ ë¡œê¹…](#51-ê¸°ë³¸-íŠ¸ë¦¬ê±°-ìƒì„±-ìë™-ë¡œê¹…)
    -   [5.2. ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ íŠ¸ë¦¬ê±°: ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥](#52-ë¹„ì¦ˆë‹ˆìŠ¤-ê·œì¹™-íŠ¸ë¦¬ê±°-ë°ì´í„°-ë¬´ê²°ì„±-ë³´ì¥)
6.  [**ì‹¤ë¬´ ì‹œë‚˜ë¦¬ì˜¤ í†µí•©**](#6-ì‹¤ë¬´-ì‹œë‚˜ë¦¬ì˜¤-í†µí•©)
    -   [6.1. ì‹œë‚˜ë¦¬ì˜¤ 1: ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ ì™„ì„±](#61-ì‹œë‚˜ë¦¬ì˜¤-1-ì¸ì‚¬-ê´€ë¦¬-ì‹œìŠ¤í…œ-ì™„ì„±)
    -   [6.2. ì‹œë‚˜ë¦¬ì˜¤ 2: í”„ë¡œì íŠ¸ í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”](#62-ì‹œë‚˜ë¦¬ì˜¤-2-í”„ë¡œì íŠ¸-í¬íŠ¸í´ë¦¬ì˜¤-ìµœì í™”)
7.  [**ë§ˆë¬´ë¦¬: í•µì‹¬ ì •ë¦¬**](#7-ë§ˆë¬´ë¦¬-í•µì‹¬-ì •ë¦¬)

---

## 1. ì„œë¸Œì¿¼ë¦¬ ì‹¬í™”: ë°ì´í„° ì¶”ì¶œì˜ ê³ ê¸‰ ê¸°ë²•

ì„œë¸Œì¿¼ë¦¬(Subquery)ëŠ” í•˜ë‚˜ì˜ SQL ë¬¸ ì•ˆì— í¬í•¨ëœ ë˜ ë‹¤ë¥¸ `SELECT` ë¬¸ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ì—¬ëŸ¬ ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ í•´ê²°í•˜ê±°ë‚˜, ë™ì ìœ¼ë¡œ ì¡°ê±´ì„ ìƒì„±í•˜ëŠ” ë“± ë‹¤ì–‘í•œ ê³ ê¸‰ ë°ì´í„° ì¶”ì¶œì— í™œìš©ë©ë‹ˆë‹¤.

### 1.1. ìƒê´€ ì„œë¸Œì¿¼ë¦¬: ì™¸ë¶€ ì¿¼ë¦¬ì™€ì˜ ì—°ë™

ìƒê´€ ì„œë¸Œì¿¼ë¦¬(Correlated Subquery)ëŠ” ì™¸ë¶€ ì¿¼ë¦¬ì˜ ê° í–‰ì— ëŒ€í•´ ì„œë¸Œì¿¼ë¦¬ê°€ ë°˜ë³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” í˜•íƒœì…ë‹ˆë‹¤. ì™¸ë¶€ ì¿¼ë¦¬ì˜ ê°’ì„ ì°¸ì¡°í•˜ì—¬ ì„œë¸Œì¿¼ë¦¬ì˜ ê²°ê³¼ë¥¼ ê²°ì •í•˜ë¯€ë¡œ, ì™¸ë¶€ ì¿¼ë¦¬ì™€ ì„œë¸Œì¿¼ë¦¬ ê°„ì— ë°€ì ‘í•œ ê´€ê³„ê°€ ìˆìŠµë‹ˆë‹¤.

#### 1.1.1. `EXISTS`ì™€ `NOT EXISTS` í™œìš©

`EXISTS`ëŠ” ì„œë¸Œì¿¼ë¦¬ì˜ ê²°ê³¼ê°€ í•œ í–‰ì´ë¼ë„ ì¡´ì¬í•˜ë©´ `TRUE`ë¥¼ ë°˜í™˜í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ `FALSE`ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. `NOT EXISTS`ëŠ” ê·¸ ë°˜ëŒ€ì…ë‹ˆë‹¤. ì£¼ë¡œ íŠ¹ì • ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ì˜ ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•  ë•Œ íš¨ìœ¨ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

```sql
-- 1. í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•œ ê²½í—˜ì´ ìˆëŠ” ì§ì›
SELECT 
    e.name,
    e.department,
    e.salary,
    e.hire_date
FROM employees e
WHERE EXISTS ( -- project_assignments í…Œì´ë¸”ì— í•´ë‹¹ ì§ì›ì˜ emp_idê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    SELECT 1 
    FROM project_assignments pa 
    WHERE pa.emp_id = e.emp_id
);

-- 2. í”„ë¡œì íŠ¸ì— í•œ ë²ˆë„ ì°¸ì—¬í•˜ì§€ ì•Šì€ ì§ì›
SELECT 
    e.name,
    e.department,
    e.salary,
    DATEDIFF(CURDATE(), e.hire_date) AS days_since_hire
FROM employees e
WHERE NOT EXISTS ( -- project_assignments í…Œì´ë¸”ì— í•´ë‹¹ ì§ì›ì˜ emp_idê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
    SELECT 1 
    FROM project_assignments pa 
    WHERE pa.emp_id = e.emp_id
)
ORDER BY days_since_hire DESC;

-- 3. ìµœê·¼ 1ë…„ê°„ ê¸‰ì—¬ ì¸ìƒì´ ì—†ëŠ” ì§ì›
SELECT 
    e.name,
    e.department,
    e.salary,
    COALESCE(
        (SELECT MAX(sh.change_date) 
         FROM salary_history sh 
         WHERE sh.emp_id = e.emp_id), 
        e.hire_date
    ) AS last_salary_change
FROM employees e
WHERE NOT EXISTS ( -- salary_historyì— ìµœê·¼ 1ë…„ ë‚´ ê¸‰ì—¬ ë³€ê²½ ì´ë ¥ì´ ì—†ëŠ”ì§€ í™•ì¸
    SELECT 1 
    FROM salary_history sh 
    WHERE sh.emp_id = e.emp_id
      AND sh.change_date >= DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
);
```

#### 1.1.2. ë¹„êµ ë¶„ì„ìš© ìƒê´€ ì„œë¸Œì¿¼ë¦¬

ìƒê´€ ì„œë¸Œì¿¼ë¦¬ëŠ” ì™¸ë¶€ ì¿¼ë¦¬ì˜ ê° í–‰ì— ëŒ€í•´ ë™ì ìœ¼ë¡œ ì¡°ê±´ì„ ìƒì„±í•˜ì—¬ ë¹„êµ ë¶„ì„ì„ ìˆ˜í–‰í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.

```sql
-- 1. ë¶€ì„œ í‰ê· ë³´ë‹¤ ê¸‰ì—¬ê°€ ë†’ì€ ì§ì›ë“¤
SELECT 
    e.name,
    e.department,
    e.salary,
    (SELECT AVG(e2.salary) 
     FROM employees e2 
     WHERE e2.department = e.department) AS dept_avg_salary, -- í•´ë‹¹ ì§ì›ì˜ ë¶€ì„œ í‰ê·  ê¸‰ì—¬
    ROUND(e.salary / (SELECT AVG(e2.salary) 
                      FROM employees e2 
                      WHERE e2.department = e.department) * 100, 1) AS salary_vs_avg_percent
FROM employees e
WHERE e.salary > ( -- í•´ë‹¹ ì§ì›ì˜ ê¸‰ì—¬ê°€ ìì‹ ì˜ ë¶€ì„œ í‰ê· ë³´ë‹¤ ë†’ì€ì§€ ë¹„êµ
    SELECT AVG(e2.salary) 
    FROM employees e2 
    WHERE e2.department = e.department
);

-- 2. ê° ë¶€ì„œì—ì„œ ê°€ì¥ ì˜¤ë˜ ê·¼ë¬´í•œ ì§ì›
SELECT 
    e.name,
    e.department,
    e.hire_date,
    DATEDIFF(CURDATE(), e.hire_date) AS days_worked
FROM employees e
WHERE e.hire_date = ( -- í•´ë‹¹ ì§ì›ì˜ ì…ì‚¬ì¼ì´ ìì‹ ì˜ ë¶€ì„œ ë‚´ ìµœì†Œ ì…ì‚¬ì¼ê³¼ ê°™ì€ì§€ ë¹„êµ
    SELECT MIN(e2.hire_date)
    FROM employees e2
    WHERE e2.department = e.department
      AND e2.hire_date IS NOT NULL
);

-- 3. í”„ë¡œì íŠ¸ë³„ ìµœê³  ê¸‰ì—¬ ì§ì›
SELECT 
    p.project_name,
    e.name AS highest_paid_member,
    e.salary,
    pa.role,
    pa.allocation_percent
FROM projects p
INNER JOIN project_assignments pa ON p.project_id = pa.project_id
INNER JOIN employees e ON pa.emp_id = e.emp_id
WHERE e.salary = ( -- í•´ë‹¹ ì§ì›ì˜ ê¸‰ì—¬ê°€ í•´ë‹¹ í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì¤‘ ìµœê³  ê¸‰ì—¬ì™€ ê°™ì€ì§€ ë¹„êµ
    SELECT MAX(e2.salary)
    FROM employees e2
    INNER JOIN project_assignments pa2 ON e2.emp_id = pa2.emp_id
    WHERE pa2.project_id = p.project_id
);
```

### 1.2. ë‹¤ì¤‘ ë ˆë²¨ ì„œë¸Œì¿¼ë¦¬: ì¤‘ì²©ëœ ì¿¼ë¦¬ì˜ í˜

ë‹¤ì¤‘ ë ˆë²¨ ì„œë¸Œì¿¼ë¦¬(Multi-level Subquery)ëŠ” ì„œë¸Œì¿¼ë¦¬ ì•ˆì— ë˜ ë‹¤ë¥¸ ì„œë¸Œì¿¼ë¦¬ê°€ ì¤‘ì²©ë˜ì–´ ìˆëŠ” í˜•íƒœì…ë‹ˆë‹¤. ì—¬ëŸ¬ ë‹¨ê³„ì˜ ì¡°ê±´ì„ ê±°ì³ ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ê±°ë‚˜ ì§‘ê³„í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤.

```sql
-- 1. ê°€ì¥ ë§ì€ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•œ ì§ì›ì´ ì†í•œ ë¶€ì„œì˜ ëª¨ë“  ì§ì›
SELECT 
    e.name,
    e.department,
    e.salary,
    (SELECT COUNT(*) 
     FROM project_assignments pa 
     WHERE pa.emp_id = e.emp_id) AS project_count
FROM employees e
WHERE e.department = ( -- ê°€ì¥ ë§ì€ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•œ ì§ì›ì˜ ë¶€ì„œë¥¼ ì°¾ê¸° ìœ„í•œ ì„œë¸Œì¿¼ë¦¬
    SELECT e2.department
    FROM employees e2
    WHERE e2.emp_id = ( -- ê°€ì¥ ë§ì€ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•œ ì§ì›ì˜ emp_idë¥¼ ì°¾ê¸° ìœ„í•œ ì„œë¸Œì¿¼ë¦¬
        SELECT pa.emp_id
        FROM project_assignments pa
        GROUP BY pa.emp_id
        ORDER BY COUNT(*) DESC
        LIMIT 1
    )
);

-- 2. í‰ê·  ê¸‰ì—¬ê°€ ê°€ì¥ ë†’ì€ ë¶€ì„œì—ì„œ ê¸‰ì—¬ê°€ ê°€ì¥ ë‚®ì€ ì§ì›
SELECT 
    e.name,
    e.department,
    e.salary,
    (SELECT AVG(e3.salary) 
     FROM employees e3 
     WHERE e3.department = e.department) AS dept_avg
FROM employees e
WHERE e.department = ( -- í‰ê·  ê¸‰ì—¬ê°€ ê°€ì¥ ë†’ì€ ë¶€ì„œë¥¼ ì°¾ê¸° ìœ„í•œ ì„œë¸Œì¿¼ë¦¬
    SELECT e2.department
    FROM employees e2
    WHERE e2.department IS NOT NULL
    GROUP BY e2.department
    ORDER BY AVG(e2.salary) DESC
    LIMIT 1
)
AND e.salary = ( -- í•´ë‹¹ ë¶€ì„œì—ì„œ ê¸‰ì—¬ê°€ ê°€ì¥ ë‚®ì€ ì§ì›ì„ ì°¾ê¸° ìœ„í•œ ì„œë¸Œì¿¼ë¦¬
    SELECT MIN(e4.salary)
    FROM employees e4
    WHERE e4.department = e.department
      AND e4.salary IS NOT NULL
);
```

### 1.3. CTE (Common Table Expression): ì¿¼ë¦¬ ê°€ë…ì„± í–¥ìƒ

CTE(Common Table Expression)ëŠ” `WITH` ì ˆì„ ì‚¬ìš©í•˜ì—¬ ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ì—¬ëŸ¬ ê°œì˜ ë…¼ë¦¬ì ì¸ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ê³  ì´ë¦„ì„ ë¶€ì—¬í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. ì¿¼ë¦¬ì˜ ê°€ë…ì„±ê³¼ ì¬ì‚¬ìš©ì„±ì„ í¬ê²Œ í–¥ìƒì‹œí‚¤ë©°, ì¬ê·€ ì¿¼ë¦¬(Recursive Query)ë¥¼ êµ¬í˜„í•  ë•Œë„ ì‚¬ìš©ë©ë‹ˆë‹¤.

```sql
-- 1. ê¸°ë³¸ CTE ì‚¬ìš©
WITH department_stats AS ( -- ë¶€ì„œë³„ í†µê³„ë¥¼ ê³„ì‚°í•˜ëŠ” CTE ì •ì˜
    SELECT 
        department,
        COUNT(*) AS emp_count,
        AVG(salary) AS avg_salary,
        MAX(salary) AS max_salary,
        MIN(salary) AS min_salary
    FROM employees
    WHERE department IS NOT NULL
    GROUP BY department
),
salary_ranks AS ( -- ì§ì›ë³„ ë¶€ì„œ ë‚´ ê¸‰ì—¬ ìˆœìœ„ë¥¼ ê³„ì‚°í•˜ëŠ” CTE ì •ì˜
    SELECT 
        name,
        department,
        salary,
        RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rank_in_dept
    FROM employees
    WHERE department IS NOT NULL
)
SELECT 
    ds.department,
    ds.emp_count,
    ds.avg_salary,
    sr.name AS top_earner,
    sr.salary AS top_salary,
    ROUND(sr.salary / ds.avg_salary * 100, 1) AS top_vs_avg_percent
FROM department_stats ds
INNER JOIN salary_ranks sr ON ds.department = sr.department
WHERE sr.rank_in_dept = 1 -- ê° ë¶€ì„œì˜ ìµœê³  ê¸‰ì—¬ ì§ì›ë§Œ ì„ íƒ
ORDER BY ds.avg_salary DESC;

-- 2. ì¬ê·€ CTE (ì¡°ì§ë„ êµ¬í˜„)
-- manager_idë¥¼ ì´ìš©í•œ ê³„ì¸µ êµ¬ì¡° ì¡°íšŒ
WITH RECURSIVE org_hierarchy AS (
    -- ì•µì»¤ ë©¤ë²„ (ì¬ê·€ì˜ ì‹œì‘ì ): ìµœìƒìœ„ ê´€ë¦¬ì (manager_idê°€ NULLì¸ ì§ì›)
    SELECT 
        emp_id,
        name,
        department,
        manager_id,
        salary,
        1 AS level, -- ê³„ì¸µ ë ˆë²¨
        CAST(name AS CHAR(1000)) AS hierarchy_path -- ê³„ì¸µ ê²½ë¡œ
    FROM employees
    WHERE manager_id IS NULL
    
    UNION ALL
    
    -- ì¬ê·€ ë©¤ë²„ (ë°˜ë³µ ë¶€ë¶„): ê° ì§ì›ì˜ ê´€ë¦¬ìë¥¼ ì°¾ì•„ ê³„ì¸µì„ í™•ì¥
    SELECT 
        e.emp_id,
        e.name,
        e.department,
        e.manager_id,
        e.salary,
        oh.level + 1, -- ë ˆë²¨ ì¦ê°€
        CONCAT(oh.hierarchy_path, ' > ', e.name) AS hierarchy_path -- ê²½ë¡œ ì¶”ê°€
    FROM employees e
    INNER JOIN org_hierarchy oh ON e.manager_id = oh.emp_id
    WHERE oh.level < 5  -- ë¬´í•œ ë£¨í”„ ë°©ì§€ (ìµœëŒ€ 5ë‹¨ê³„ê¹Œì§€ë§Œ íƒìƒ‰)
)
SELECT 
    CONCAT(REPEAT('  ', level - 1), name) AS org_chart, -- ë“¤ì—¬ì“°ê¸°ë¡œ ê³„ì¸µ í‘œí˜„
    department,
    salary,
    level,
    hierarchy_path
FROM org_hierarchy
ORDER BY hierarchy_path;
```

---

## 2. `CASE` ë¬¸: ì¡°ê±´ë¶€ ë¡œì§ì˜ êµ¬í˜„

`CASE` ë¬¸ì€ SQL ì¿¼ë¦¬ ë‚´ì—ì„œ ì¡°ê±´ì— ë”°ë¼ ë‹¤ë¥¸ ê°’ì„ ë°˜í™˜í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê°•ë ¥í•œ ì¡°ê±´ë¬¸ì…ë‹ˆë‹¤. ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì„ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ êµ¬í˜„í•˜ê±°ë‚˜, ë°ì´í„°ë¥¼ ë¶„ë¥˜í•˜ê³  ì¬êµ¬ì„±í•  ë•Œ ìœ ìš©í•˜ê²Œ ì‚¬ìš©ë©ë‹ˆë‹¤.

### 2.1. `CASE` ë¬¸ì˜ ê¸°ë³¸: ë‹¨ìˆœ vs ê²€ìƒ‰

`CASE` ë¬¸ì€ í¬ê²Œ ë‘ ê°€ì§€ í˜•íƒœë¡œ ë‚˜ë‰©ë‹ˆë‹¤.

#### 2.1.1. ë‹¨ìˆœ `CASE` (ê°’ ë¹„êµ)

íŠ¹ì • ì—´ì˜ ê°’ì´ ë¯¸ë¦¬ ì •ì˜ëœ ê°’ë“¤ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ë¹„êµí•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. `WHEN` ì ˆ ë’¤ì— ë¹„êµí•  ê°’ì„ ì§ì ‘ ëª…ì‹œí•©ë‹ˆë‹¤.

```sql
-- ë¶€ì„œ ì½”ë“œë¥¼ ë¶€ì„œëª…ìœ¼ë¡œ ë³€í™˜
SELECT 
    name,
    department,
    salary,
    CASE department -- department ì»¬ëŸ¼ì˜ ê°’ê³¼ ì¼ì¹˜í•˜ëŠ” WHEN ì ˆ ì‹¤í–‰
        WHEN 'ê°œë°œíŒ€' THEN 'Development'
        WHEN 'ë§ˆì¼€íŒ…íŒ€' THEN 'Marketing'
        WHEN 'ë””ìì¸íŒ€' THEN 'Design'
        WHEN 'ì˜ì—…íŒ€' THEN 'Sales'
        WHEN 'ì¸ì‚¬íŒ€' THEN 'HR'
        ELSE 'Other' -- ì¼ì¹˜í•˜ëŠ” ê°’ì´ ì—†ì„ ê²½ìš°
    END AS dept_english,
    -- ê¸‰ì—¬ í†µí™” í‘œì‹œ
    CASE 
        WHEN salary >= 10000000 THEN CONCAT(FORMAT(salary/10000, 0), 'ë§Œì›')
        WHEN salary >= 1000000 THEN CONCAT(FORMAT(salary/10000, 1), 'ë§Œì›')
        ELSE CONCAT(FORMAT(salary, 0), 'ì›')
    END AS salary_display
FROM employees;
```

#### 2.1.2. ê²€ìƒ‰ `CASE` (ì¡°ê±´ ë¹„êµ)

ê° `WHEN` ì ˆ ë’¤ì— ë…¼ë¦¬ì ì¸ ì¡°ê±´(ì˜ˆ: `salary >= 5000000`)ì„ ëª…ì‹œí•˜ì—¬ ë” ë³µì¡í•œ ì¡°ê±´ë¶€ ë¡œì§ì„ êµ¬í˜„í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. ì¡°ê±´ì€ ìˆœì„œëŒ€ë¡œ í‰ê°€ë˜ë©°, ì²« ë²ˆì§¸ë¡œ `TRUE`ê°€ ë˜ëŠ” `WHEN` ì ˆì˜ ê²°ê³¼ê°€ ë°˜í™˜ë©ë‹ˆë‹¤.

```sql
-- ë³µí•© ë“±ê¸‰ ì‹œìŠ¤í…œ
SELECT 
    name,
    department,
    salary,
    hire_date,
    DATEDIFF(CURDATE(), hire_date) / 365 AS years_of_service,
    -- ë³µí•© ë“±ê¸‰ ê³„ì‚°
    CASE 
        WHEN salary >= 6000000 AND DATEDIFF(CURDATE(), hire_date) >= 1095 THEN 'Sê¸‰ (ì‹œë‹ˆì–´)'
        WHEN salary >= 5000000 AND DATEDIFF(CURDATE(), hire_date) >= 730 THEN 'Aê¸‰ (ê³ ê¸‰)'
        WHEN salary >= 4000000 AND DATEDIFF(CURDATE(), hire_date) >= 365 THEN 'Bê¸‰ (ì¤‘ê¸‰)'
        WHEN salary >= 3000000 THEN 'Cê¸‰ (ì´ˆê¸‰)'
        ELSE 'Dê¸‰ (ìˆ˜ìŠµ)'
    END AS employee_grade,
    -- ìŠ¹ì§„ ê°€ëŠ¥ì„±
    CASE 
        WHEN salary >= 5000000 THEN 'ìŠ¹ì§„ ëŒ€ìƒ'
        WHEN salary >= 4000000 AND DATEDIFF(CURDATE(), hire_date) >= 365 THEN 'ìŠ¹ì§„ ê²€í† '
        WHEN DATEDIFF(CURDATE(), hire_date) >= 180 THEN 'í‰ê°€ ëŒ€ê¸°'
        ELSE 'ìˆ˜ìŠµ ì¤‘'
    END AS promotion_status
FROM employees
WHERE salary IS NOT NULL;
```

### 2.2. ì¤‘ì²© `CASE`ì™€ ë³µí•© ì¡°ê±´: ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

`CASE` ë¬¸ ì•ˆì— ë˜ ë‹¤ë¥¸ `CASE` ë¬¸ì„ ì¤‘ì²©í•˜ì—¬ ì‚¬ìš©í•˜ê±°ë‚˜, ì—¬ëŸ¬ ì¡°ê±´ì„ `AND`, `OR`ë¡œ ì¡°í•©í•˜ì—¬ ë§¤ìš° ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
-- í”„ë¡œì íŠ¸ ì°¸ì—¬ì ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ
SELECT 
    e.name,
    e.department,
    p.project_name,
    pa.role,
    pa.allocation_percent,
    p.status AS project_status,
    DATEDIFF(CURDATE(), pa.start_date) AS days_on_project,
    -- ë³µí•© ì„±ê³¼ ë“±ê¸‰
    CASE 
        WHEN p.status = 'Completed' THEN -- í”„ë¡œì íŠ¸ê°€ ì™„ë£Œëœ ê²½ìš°
            CASE 
                WHEN pa.allocation_percent >= 80 AND pa.role LIKE '%Lead%' THEN 'A+ (í”„ë¡œì íŠ¸ ë¦¬ë” ì™„ë£Œ)'
                WHEN pa.allocation_percent >= 50 THEN 'A (í•µì‹¬ ê¸°ì—¬ì)'
                ELSE 'B+ (ê¸°ì—¬ì)'
            END
        WHEN p.status = 'In Progress' THEN -- í”„ë¡œì íŠ¸ê°€ ì§„í–‰ ì¤‘ì¸ ê²½ìš°
            CASE 
                WHEN pa.allocation_percent >= 100 THEN 'B (ê³¼ë¶€í•˜ ì£¼ì˜)'
                WHEN pa.allocation_percent >= 70 THEN 'B+ (í•µì‹¬ ì§„í–‰)'
                WHEN pa.allocation_percent >= 30 THEN 'C+ (ë¶€ë¶„ ì°¸ì—¬)'
                ELSE 'C (ìµœì†Œ ì°¸ì—¬)'
            END
        WHEN p.status = 'Planning' THEN 'D (ê³„íš ë‹¨ê³„)'
        ELSE 'E (ë¯¸ë¶„ë¥˜)'
    END AS performance_grade,
    -- ë³´ìƒ ê¶Œê³ 
    CASE 
        WHEN p.status = 'Completed' AND pa.allocation_percent >= 80 THEN
            ROUND(e.salary * 0.1, 0)  -- 10% ë³´ë„ˆìŠ¤
        WHEN p.status = 'Completed' AND pa.allocation_percent >= 50 THEN
            ROUND(e.salary * 0.05, 0)  -- 5% ë³´ë„ˆìŠ¤
        WHEN p.status = 'In Progress' AND pa.allocation_percent >= 100 THEN
            ROUND(e.salary * 0.02, 0)  -- 2% ê³¼ë¶€í•˜ ìˆ˜ë‹¹
        ELSE 0
    END AS recommended_bonus
FROM employees e
INNER JOIN project_assignments pa ON e.emp_id = pa.emp_id
INNER JOIN projects p ON pa.project_id = p.project_id;
```

### 2.3. `CASE` ë¬¸ì„ í™œìš©í•œ í”¼ë²— í…Œì´ë¸”: ë°ì´í„° ì¬êµ¬ì„±

`CASE` ë¬¸ê³¼ ì§‘ê³„ í•¨ìˆ˜ë¥¼ ì¡°í•©í•˜ë©´ í–‰(Row)ìœ¼ë¡œ ë‚˜ì—´ëœ ë°ì´í„°ë¥¼ ì—´(Column)ë¡œ ì¬êµ¬ì„±í•˜ëŠ” **í”¼ë²—(Pivot)** ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” íŠ¹ì • ê¸°ì¤€ì— ë”°ë¼ ë°ì´í„°ë¥¼ ìš”ì•½í•˜ê³  ë¹„êµí•˜ëŠ” ë° ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤.

```sql
-- ë¶€ì„œë³„ ì›”ë³„ ì…ì‚¬ì ìˆ˜ í”¼ë²— í…Œì´ë¸”
SELECT 
    department,
    SUM(CASE WHEN MONTH(hire_date) = 1 THEN 1 ELSE 0 END) AS Jan,
    SUM(CASE WHEN MONTH(hire_date) = 2 THEN 1 ELSE 0 END) AS Feb,
    SUM(CASE WHEN MONTH(hire_date) = 3 THEN 1 ELSE 0 END) AS Mar,
    SUM(CASE WHEN MONTH(hire_date) = 4 THEN 1 ELSE 0 END) AS Apr,
    SUM(CASE WHEN MONTH(hire_date) = 5 THEN 1 ELSE 0 END) AS May,
    SUM(CASE WHEN MONTH(hire_date) = 6 THEN 1 ELSE 0 END) AS Jun,
    SUM(CASE WHEN MONTH(hire_date) = 7 THEN 1 ELSE 0 END) AS Jul,
    SUM(CASE WHEN MONTH(hire_date) = 8 THEN 1 ELSE 0 END) AS Aug,
    SUM(CASE WHEN MONTH(hire_date) = 9 THEN 1 ELSE 0 END) AS Sep,
    SUM(CASE WHEN MONTH(hire_date) = 10 THEN 1 ELSE 0 END) AS Oct,
    SUM(CASE WHEN MONTH(hire_date) = 11 THEN 1 ELSE 0 END) AS Nov,
    SUM(CASE WHEN MONTH(hire_date) = 12 THEN 1 ELSE 0 END) AS Dec,
    COUNT(*) AS Total
FROM employees
WHERE hire_date IS NOT NULL AND department IS NOT NULL
GROUP BY department
ORDER BY Total DESC;

-- ê¸‰ì—¬ êµ¬ê°„ë³„ ë¶€ì„œ ë¶„í¬
SELECT 
    CASE 
        WHEN salary < 3500000 THEN '3500ë§Œì› ë¯¸ë§Œ'
        WHEN salary < 4000000 THEN '3500-4000ë§Œì›'
        WHEN salary < 4500000 THEN '4000-4500ë§Œì›'
        WHEN salary < 5000000 THEN '4500-5000ë§Œì›'
        WHEN salary < 5500000 THEN '5000-5500ë§Œì›'
        ELSE '5500ë§Œì› ì´ìƒ'
    END AS salary_range,
    SUM(CASE WHEN department = 'ê°œë°œíŒ€' THEN 1 ELSE 0 END) AS ê°œë°œíŒ€,
    SUM(CASE WHEN department = 'ë§ˆì¼€íŒ…íŒ€' THEN 1 ELSE 0 END) AS ë§ˆì¼€íŒ…íŒ€,
    SUM(CASE WHEN department = 'ë””ìì¸íŒ€' THEN 1 ELSE 0 END) AS ë””ìì¸íŒ€,
    SUM(CASE WHEN department = 'ì˜ì—…íŒ€' THEN 1 ELSE 0 END) AS ì˜ì—…íŒ€,
    SUM(CASE WHEN department = 'ì¸ì‚¬íŒ€' THEN 1 ELSE 0 END) AS ì¸ì‚¬íŒ€,
    COUNT(*) AS Total
FROM employees
WHERE salary IS NOT NULL AND department IS NOT NULL
GROUP BY 
    CASE 
        WHEN salary < 3500000 THEN '3500ë§Œì› ë¯¸ë§Œ'
        WHEN salary < 4000000 THEN '3500-4000ë§Œì›'
        WHEN salary < 4500000 THEN '4000-4500ë§Œì›'
        WHEN salary < 5000000 THEN '4500-5000ë§Œì›'
        WHEN salary < 5500000 THEN '5000-5500ë§Œì›'
        ELSE '5500ë§Œì› ì´ìƒ'
    END
ORDER BY MIN(salary);
```

---

## 3. ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ (UDF): ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ë¡œì§

ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜(User-Defined Function, UDF)ëŠ” SQL ì¿¼ë¦¬ ë‚´ì—ì„œ íŠ¹ì • ê³„ì‚°ì´ë‚˜ ë¡œì§ì„ ìˆ˜í–‰í•˜ê³  ë‹¨ì¼ ê°’ì„ ë°˜í™˜í•˜ëŠ” ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ê°ì²´ì…ë‹ˆë‹¤. ë³µì¡í•œ ê³„ì‚°ì„ ìº¡ìŠí™”í•˜ì—¬ ì¿¼ë¦¬ì˜ ê°€ë…ì„±ì„ ë†’ì´ê³  ìœ ì§€ë³´ìˆ˜ë¥¼ ìš©ì´í•˜ê²Œ í•©ë‹ˆë‹¤.

### 3.1. í•¨ìˆ˜ ìƒì„± ê¸°ì´ˆ: ê°„ë‹¨í•œ í•¨ìˆ˜ ë§Œë“¤ê¸°

í•¨ìˆ˜ë¥¼ ìƒì„±í•  ë•ŒëŠ” `CREATE FUNCTION` êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ë©°, í•¨ìˆ˜ì˜ ì´ë¦„, ë§¤ê°œë³€ìˆ˜, ë°˜í™˜ íƒ€ì…, ê·¸ë¦¬ê³  í•¨ìˆ˜ ë³¸ë¬¸ì„ ì •ì˜í•©ë‹ˆë‹¤. `DELIMITER`ë¥¼ ì‚¬ìš©í•˜ì—¬ SQL ë¬¸ì˜ ëì„ ë‚˜íƒ€ë‚´ëŠ” êµ¬ë¶„ìë¥¼ ì„ì‹œë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.

```sql
-- êµ¬ë¶„ì ë³€ê²½ (í•¨ìˆ˜ ìƒì„± ì‹œ í•„ìš”)
DELIMITER //

-- 1. ê¸‰ì—¬ ë“±ê¸‰ ê³„ì‚° í•¨ìˆ˜
CREATE FUNCTION GetSalaryGrade(emp_salary DECIMAL(10,2))
RETURNS VARCHAR(10)
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE grade VARCHAR(10);
    
    IF emp_salary >= 6000000 THEN
        SET grade = 'Sê¸‰';
    ELSEIF emp_salary >= 5000000 THEN
        SET grade = 'Aê¸‰';
    ELSEIF emp_salary >= 4000000 THEN
        SET grade = 'Bê¸‰';
    ELSEIF emp_salary >= 3000000 THEN
        SET grade = 'Cê¸‰';
    ELSE
        SET grade = 'Dê¸‰';
    END IF;
    
    RETURN grade;
END //

-- 2. ê·¼ë¬´ ë…„ìˆ˜ ê³„ì‚° í•¨ìˆ˜
CREATE FUNCTION GetYearsOfService(hire_date DATE)
RETURNS DECIMAL(4,2)
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE years_worked DECIMAL(4,2);
    
    IF hire_date IS NULL THEN
        RETURN 0;
    END IF;
    
    SET years_worked = DATEDIFF(CURDATE(), hire_date) / 365.25;
    
    RETURN ROUND(years_worked, 2);
END //

-- 3. í•œêµ­ì–´ ìˆ«ì í¬ë§· í•¨ìˆ˜
CREATE FUNCTION FormatKoreanNumber(amount DECIMAL(15,2))
RETURNS VARCHAR(50)
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE formatted VARCHAR(50);
    
    IF amount >= 100000000 THEN
        SET formatted = CONCAT(FORMAT(amount/100000000, 1), 'ì–µì›');
    ELSEIF amount >= 10000 THEN
        SET formatted = CONCAT(FORMAT(amount/10000, 0), 'ë§Œì›');
    ELSE
        SET formatted = CONCAT(FORMAT(amount, 0), 'ì›');
    END IF;
    
    RETURN formatted;
END //

DELIMITER ;

-- í•¨ìˆ˜ ì‚¬ìš© ì˜ˆì‹œ
SELECT 
    name,
    salary,
    GetSalaryGrade(salary) AS salary_grade,
    GetYearsOfService(hire_date) AS years_of_service,
    FormatKoreanNumber(salary) AS salary_formatted
FROM employees
WHERE salary IS NOT NULL;
```

### 3.2. ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í•¨ìˆ˜: ì¢…í•© í‰ê°€ í•¨ìˆ˜

ì—¬ëŸ¬ ìš”ì†Œë¥¼ ì¡°í•©í•˜ì—¬ ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í•¨ìˆ˜ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ë‚´ì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ í‰ê°€í•˜ê³  ë¶„ë¥˜í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.

```sql
DELIMITER //

-- ì§ì› ì¢…í•© ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜
CREATE FUNCTION CalculateEmployeeScore(
    emp_id INT,
    current_salary DECIMAL(10,2),
    hire_date DATE,
    dept_name VARCHAR(50)
)
RETURNS INT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE total_score INT DEFAULT 0;
    DECLARE salary_score INT DEFAULT 0;
    DECLARE tenure_score INT DEFAULT 0;
    DECLARE project_score INT DEFAULT 0;
    DECLARE dept_avg_salary DECIMAL(10,2);
    DECLARE project_count INT;
    DECLARE years_worked DECIMAL(4,2);
    
    -- ê·¼ë¬´ ë…„ìˆ˜ ê³„ì‚°
    SET years_worked = DATEDIFF(CURDATE(), hire_date) / 365.25;
    
    -- ë¶€ì„œ í‰ê·  ê¸‰ì—¬ ì¡°íšŒ
    SELECT AVG(salary) INTO dept_avg_salary
    FROM employees 
    WHERE department = dept_name AND salary IS NOT NULL;
    
    -- í”„ë¡œì íŠ¸ ì°¸ì—¬ ìˆ˜ ì¡°íšŒ
    SELECT COUNT(*) INTO project_count
    FROM project_assignments 
    WHERE project_assignments.emp_id = emp_id;
    
    -- ê¸‰ì—¬ ì ìˆ˜ (40ì  ë§Œì )
    IF current_salary >= dept_avg_salary * 1.3 THEN
        SET salary_score = 40;
    ELSEIF current_salary >= dept_avg_salary * 1.1 THEN
        SET salary_score = 30;
    ELSEIF current_salary >= dept_avg_salary * 0.9 THEN
        SET salary_score = 20;
    ELSE
        SET salary_score = 10;
    END IF;
    
    -- ê·¼ì† ì ìˆ˜ (30ì  ë§Œì )
    IF years_worked >= 5 THEN
        SET tenure_score = 30;
    ELSEIF years_worked >= 3 THEN
        SET tenure_score = 25;
    ELSEIF years_worked >= 1 THEN
        SET tenure_score = 15;
    ELSE
        SET tenure_score = 5;
    END IF;
    
    -- í”„ë¡œì íŠ¸ ì°¸ì—¬ ì ìˆ˜ (30ì  ë§Œì )
    IF project_count >= 3 THEN
        SET project_score = 30;
    ELSEIF project_count >= 2 THEN
        SET project_score = 20;
    ELSEIF project_count >= 1 THEN
        SET project_score = 10;
    ELSE
        SET project_score = 0;
    END IF;
    
    SET total_score = salary_score + tenure_score + project_score;
    
    RETURN total_score;
END //

DELIMITER ;

-- í•¨ìˆ˜ í™œìš© ì˜ˆì‹œ
SELECT 
    e.name,
    e.department,
    e.salary,
    GetYearsOfService(e.hire_date) AS years_worked,
    (SELECT COUNT(*) FROM project_assignments pa WHERE pa.emp_id = e.emp_id) AS project_count,
    CalculateEmployeeScore(e.emp_id, e.salary, e.hire_date, e.department) AS total_score,
    CASE 
        WHEN CalculateEmployeeScore(e.emp_id, e.salary, e.hire_date, e.department) >= 80 THEN 'Së“±ê¸‰'
        WHEN CalculateEmployeeScore(e.emp_id, e.salary, e.hire_date, e.department) >= 60 THEN 'Aë“±ê¸‰'
        WHEN CalculateEmployeeScore(e.emp_id, e.salary, e.hire_date, e.department) >= 40 THEN 'Bë“±ê¸‰'
        ELSE 'Cë“±ê¸‰'
    END AS performance_grade
FROM employees e
WHERE e.salary IS NOT NULL
ORDER BY total_score DESC;
```

---

## 4. ì €ì¥ í”„ë¡œì‹œì € (Stored Procedure): ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìº¡ìŠí™”

ì €ì¥ í”„ë¡œì‹œì €(Stored Procedure)ëŠ” ì¼ë ¨ì˜ SQL ë¬¸ì„ ë¯¸ë¦¬ ì»´íŒŒì¼í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•´ë‘ê³ , í•„ìš”í•  ë•Œë§ˆë‹¤ í˜¸ì¶œí•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê°ì²´ì…ë‹ˆë‹¤. ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìº¡ìŠí™”í•˜ê³ , ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì¤„ì´ë©°, ë³´ì•ˆì„ ê°•í™”í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

### 4.1. ê¸°ë³¸ ì €ì¥ í”„ë¡œì‹œì €: ë§¤ê°œë³€ìˆ˜ í™œìš©

ì €ì¥ í”„ë¡œì‹œì €ëŠ” `IN`(ì…ë ¥), `OUT`(ì¶œë ¥), `INOUT`(ì…ë ¥ ë° ì¶œë ¥) ë§¤ê°œë³€ìˆ˜ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì™¸ë¶€ì—ì„œ ê°’ì„ ì „ë‹¬ë°›ê±°ë‚˜, ì²˜ë¦¬ ê²°ê³¼ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
DELIMITER //

-- 1. ë¶€ì„œë³„ ê¸‰ì—¬ í˜„í™© ì¡°íšŒ í”„ë¡œì‹œì €
CREATE PROCEDURE GetDepartmentSalaryReport(
    IN dept_name VARCHAR(50) -- ì…ë ¥ ë§¤ê°œë³€ìˆ˜: ì¡°íšŒí•  ë¶€ì„œëª…
)
BEGIN
    SELECT 
        e.name,
        e.salary,
        e.hire_date,
        GetYearsOfService(e.hire_date) AS years_worked, -- ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ í™œìš©
        RANK() OVER (ORDER BY e.salary DESC) AS salary_rank
    FROM employees e
    WHERE e.department = dept_name
      AND e.salary IS NOT NULL
    ORDER BY e.salary DESC;
    
    -- ë¶€ì„œ ìš”ì•½ ì •ë³´ë„ í•¨ê»˜ ì¶œë ¥
    SELECT 
        COUNT(*) AS total_employees,
        AVG(salary) AS avg_salary,
        MAX(salary) AS max_salary,
        MIN(salary) AS min_salary,
        SUM(salary) AS total_salary_cost
    FROM employees
    WHERE department = dept_name
      AND salary IS NOT NULL;
END //

-- 2. ê¸‰ì—¬ ì¸ìƒ í”„ë¡œì‹œì € (ì•ˆì „ì¥ì¹˜ í¬í•¨)
CREATE PROCEDURE AdjustSalary(
    IN emp_id INT,
    IN increase_percent DECIMAL(5,2),
    IN reason VARCHAR(100),
    OUT result_message VARCHAR(200) -- ì¶œë ¥ ë§¤ê°œë³€ìˆ˜: ê²°ê³¼ ë©”ì‹œì§€
)
BEGIN
    DECLARE current_salary DECIMAL(10,2);
    DECLARE new_salary DECIMAL(10,2);
    DECLARE emp_name VARCHAR(50);
    DECLARE emp_dept VARCHAR(50);
    
    -- ì˜ˆì™¸ ì²˜ë¦¬ ì„ ì–¸: SQL ì—ëŸ¬ ë°œìƒ ì‹œ ë©”ì‹œì§€ ì„¤ì • í›„ ë¡¤ë°±
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
    BEGIN
        SET result_message = 'ERROR: ê¸‰ì—¬ ì¡°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        ROLLBACK;
    END;
    
    -- íŠ¸ëœì­ì…˜ ì‹œì‘: ì—¬ëŸ¬ SQL ë¬¸ì„ í•˜ë‚˜ì˜ ë…¼ë¦¬ì  ì‘ì—… ë‹¨ìœ„ë¡œ ë¬¶ìŒ
    START TRANSACTION;
    
    -- í˜„ì¬ ê¸‰ì—¬ ì •ë³´ ì¡°íšŒ
    SELECT name, department, salary 
    INTO emp_name, emp_dept, current_salary
    FROM employees 
    WHERE employees.emp_id = emp_id;
    
    -- ì§ì› ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    IF current_salary IS NULL THEN
        SET result_message = 'ERROR: í•´ë‹¹ ì§ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        ROLLBACK; -- íŠ¸ëœì­ì…˜ ì·¨ì†Œ
    ELSE
        -- ì¸ìƒë¥  ê²€ì¦ (ìµœëŒ€ 50% ê¹Œì§€ë§Œ í—ˆìš©)
        IF increase_percent > 50 OR increase_percent < -20 THEN
            SET result_message = 'ERROR: ì¸ìƒë¥ ì€ -20% ~ 50% ë²”ìœ„ ë‚´ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            ROLLBACK;
        ELSE
            -- ìƒˆë¡œìš´ ê¸‰ì—¬ ê³„ì‚°
            SET new_salary = current_salary * (1 + increase_percent / 100);
            
            -- ê¸‰ì—¬ ì—…ë°ì´íŠ¸
            UPDATE employees 
            SET salary = new_salary, updated_at = NOW()
            WHERE employees.emp_id = emp_id;
            
            -- ê¸‰ì—¬ ì´ë ¥ ê¸°ë¡ (salary_history í…Œì´ë¸”ì— INSERT)
            INSERT INTO salary_history (emp_id, old_salary, new_salary, change_date, change_reason, approved_by)
            VALUES (emp_id, current_salary, new_salary, CURDATE(), reason, USER()); -- USER()ëŠ” í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ë°˜í™˜
            
            -- ì„±ê³µ ë©”ì‹œì§€
            SET result_message = CONCAT(
                'SUCCESS: ', emp_name, '(', emp_dept, ')ì˜ ê¸‰ì—¬ê°€ ',
                FormatKoreanNumber(current_salary), 'ì—ì„œ ',
                FormatKoreanNumber(new_salary), 'ë¡œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤. (', increase_percent, '%)'
            );
            
            COMMIT; -- íŠ¸ëœì­ì…˜ í™•ì •
        END IF;
    END IF;
END //

DELIMITER ;

-- í”„ë¡œì‹œì € ì‚¬ìš© ì˜ˆì‹œ
CALL GetDepartmentSalaryReport('ê°œë°œíŒ€');

-- ê¸‰ì—¬ ì¡°ì • ì˜ˆì‹œ
SET @result = ''; -- ì¶œë ¥ ë§¤ê°œë³€ìˆ˜ë¥¼ ë°›ì„ ë³€ìˆ˜ ì„ ì–¸
CALL AdjustSalary(1, 5.5, '2024ë…„ ì„±ê³¼ í‰ê°€ ë°˜ì˜', @result);
SELECT @result AS adjustment_result; -- ê²°ê³¼ í™•ì¸
```

### 4.2. ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í”„ë¡œì‹œì €: ì„±ê³¼ í‰ê°€ ë° ë³´ìƒ

ì €ì¥ í”„ë¡œì‹œì €ëŠ” ì»¤ì„œ(Cursor)ì™€ ì„ì‹œ í…Œì´ë¸”(Temporary Table)ì„ í™œìš©í•˜ì—¬ ë³µì¡í•œ ë°ì´í„° ì²˜ë¦¬ ë° ë¶„ì„ ë¡œì§ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©° ê°œë³„ì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì„ ì ìš©í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.

```sql
DELIMITER //

-- ì—°ê°„ ì„±ê³¼ í‰ê°€ ë° ë³´ìƒ ê³„ì‚° í”„ë¡œì‹œì €
CREATE PROCEDURE ProcessAnnualPerformanceReview(
    IN review_year INT,
    IN budget_limit DECIMAL(15,2) -- ì´ ë³´ìƒ ì˜ˆì‚° í•œë„
)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE emp_id INT;
    DECLARE emp_name VARCHAR(50);
    DECLARE current_salary DECIMAL(10,2);
    DECLARE performance_score INT;
    DECLARE recommended_increase DECIMAL(5,2);
    DECLARE bonus_amount DECIMAL(10,2);
    DECLARE total_cost DECIMAL(15,2) DEFAULT 0; -- í˜„ì¬ê¹Œì§€ ì‚¬ìš©ëœ ì˜ˆì‚°
    
    -- ì»¤ì„œ ì„ ì–¸: employees í…Œì´ë¸”ì„ ìˆœíšŒí•˜ë©° ì§ì› ì •ë³´ì™€ ì„±ê³¼ ì ìˆ˜ë¥¼ ê°€ì ¸ì˜´
    DECLARE emp_cursor CURSOR FOR
        SELECT e.emp_id, e.name, e.salary,
               CalculateEmployeeScore(e.emp_id, e.salary, e.hire_date, e.department) AS score -- ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ í™œìš©
        FROM employees e
        WHERE e.salary IS NOT NULL
        ORDER BY CalculateEmployeeScore(e.emp_id, e.salary, e.hire_date, e.department) DESC; -- ì„±ê³¼ ì ìˆ˜ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬
    
    -- ì»¤ì„œê°€ ë” ì´ìƒ í–‰ì„ ì°¾ì§€ ëª»í–ˆì„ ë•Œ done ë³€ìˆ˜ë¥¼ TRUEë¡œ ì„¤ì •
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- ê²°ê³¼ í…Œì´ë¸” ì„ì‹œ ìƒì„±: í”„ë¡œì‹œì € ì‹¤í–‰ ë™ì•ˆë§Œ ì¡´ì¬í•˜ë©°, ê²°ê³¼ ì €ì¥
    DROP TEMPORARY TABLE IF EXISTS performance_review_results;
    CREATE TEMPORARY TABLE performance_review_results (
        emp_id INT,
        emp_name VARCHAR(50),
        current_salary DECIMAL(10,2),
        performance_score INT,
        performance_grade VARCHAR(10),
        salary_increase_percent DECIMAL(5,2),
        new_salary DECIMAL(10,2),
        bonus_amount DECIMAL(10,2),
        total_compensation_increase DECIMAL(10,2) -- ì´ ë³´ìƒ ì¦ê°€ì•¡
    );
    
    -- ì»¤ì„œ ì˜¤í”ˆ
    OPEN emp_cursor;
    
    read_loop: LOOP -- ë£¨í”„ ì‹œì‘
        FETCH emp_cursor INTO emp_id, emp_name, current_salary, performance_score; -- ì»¤ì„œì—ì„œ ë‹¤ìŒ í–‰ ê°€ì ¸ì˜¤ê¸°
        
        IF done THEN -- ë” ì´ìƒ ê°€ì ¸ì˜¬ í–‰ì´ ì—†ìœ¼ë©´ ë£¨í”„ ì¢…ë£Œ
            LEAVE read_loop;
        END IF;
        
        -- ì„±ê³¼ ì ìˆ˜ì— ë”°ë¥¸ ì¸ìƒë¥  ë° ë³´ë„ˆìŠ¤ ê³„ì‚° (CASE ë¬¸ í™œìš©)
        CASE 
            WHEN performance_score >= 80 THEN
                SET recommended_increase = 8.0;
                SET bonus_amount = current_salary * 0.15;
            WHEN performance_score >= 60 THEN
                SET recommended_increase = 5.0;
                SET bonus_amount = current_salary * 0.10;
            WHEN performance_score >= 40 THEN
                SET recommended_increase = 3.0;
                SET bonus_amount = current_salary * 0.05;
            ELSE
                SET recommended_increase = 0.0;
                SET bonus_amount = 0;
        END CASE;
        
        -- ì˜ˆì‚° í•œë„ í™•ì¸ ë° ì¡°ì •
        IF total_cost + (current_salary * recommended_increase / 100) + bonus_amount <= budget_limit THEN
            SET total_cost = total_cost + (current_salary * recommended_increase / 100) + bonus_amount;
        ELSE
            -- ì˜ˆì‚° ì´ˆê³¼ ì‹œ ì¸ìƒë¥  ë° ë³´ë„ˆìŠ¤ ì ˆë°˜ìœ¼ë¡œ ì¡°ì •
            SET recommended_increase = recommended_increase * 0.5;
            SET bonus_amount = bonus_amount * 0.5;
        END IF;
        
        -- ê²°ê³¼ ì„ì‹œ í…Œì´ë¸”ì— ì‚½ì…
        INSERT INTO performance_review_results VALUES (
            emp_id,
            emp_name,
            current_salary,
            performance_score,
            CASE 
                WHEN performance_score >= 80 THEN 'Së“±ê¸‰'
                WHEN performance_score >= 60 THEN 'Aë“±ê¸‰'
                WHEN performance_score >= 40 THEN 'Bë“±ê¸‰'
                ELSE 'Cë“±ê¸‰'
            END,
            recommended_increase,
            current_salary * (1 + recommended_increase / 100),
            bonus_amount,
            (current_salary * recommended_increase / 100) + bonus_amount
        );
        
    END LOOP; -- ë£¨í”„ ì¢…ë£Œ
    
    CLOSE emp_cursor; -- ì»¤ì„œ ë‹«ê¸°
    
    -- ìµœì¢… ê²°ê³¼ ì¶œë ¥
    SELECT * FROM performance_review_results
    ORDER BY performance_score DESC;
    
    -- ìš”ì•½ ì •ë³´ ì¶œë ¥
    SELECT 
        COUNT(*) AS total_employees_reviewed,
        SUM(total_compensation_increase) AS total_budget_used,
        budget_limit - SUM(total_compensation_increase) AS remaining_budget,
        AVG(salary_increase_percent) AS avg_increase_percent
    FROM performance_review_results;
    
END //

DELIMITER ;

-- í”„ë¡œì‹œì € ì‹¤í–‰
CALL ProcessAnnualPerformanceReview(2024, 50000000); -- 2024ë…„ë„ í‰ê°€, ì˜ˆì‚° 5ì²œë§Œì›
```

### 4.3. í”„ë¡œì íŠ¸ ê´€ë¦¬ í”„ë¡œì‹œì €: í”„ë¡œì íŠ¸ ë°°ì • ìë™í™”

ì €ì¥ í”„ë¡œì‹œì €ëŠ” JSON ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ê³ , ë³µì¡í•œ ì¡°ê±´ì— ë”°ë¼ ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ë©°, ì„ì‹œ í…Œì´ë¸”ì„ í™œìš©í•˜ì—¬ ìµœì ì˜ ê²°ê³¼ë¥¼ ë„ì¶œí•˜ëŠ” ë“± ê³ ê¸‰ ë°ì´í„° ì²˜ë¦¬ ë¡œì§ì„ êµ¬í˜„í•˜ëŠ” ë° í™œìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
DELIMITER //

-- í”„ë¡œì íŠ¸ íŒ€ êµ¬ì„± ìµœì í™” í”„ë¡œì‹œì €
CREATE PROCEDURE OptimizeProjectTeam(
    IN project_id INT,
    IN required_roles JSON, -- JSON í˜•ì‹ìœ¼ë¡œ í•„ìš”í•œ ì—­í• ê³¼ ì¸ì› ìˆ˜ ì „ë‹¬ (ì˜ˆ: '[{"role": "Lead Developer", "count": 1}, ...]')
    OUT team_composition TEXT -- ì¶œë ¥ ë§¤ê°œë³€ìˆ˜: ìµœì¢… íŒ€ êµ¬ì„± ìš”ì•½
)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE role_name VARCHAR(50);
    DECLARE role_count INT;
    DECLARE selected_employees TEXT DEFAULT '';
    
    -- JSON íŒŒì‹±ì„ ìœ„í•œ ë³€ìˆ˜
    DECLARE role_index INT DEFAULT 0;
    DECLARE total_roles INT;
    
    -- ì„ì‹œ ê²°ê³¼ í…Œì´ë¸”: ìµœì ì˜ íŒ€ êµ¬ì„±ì› ì €ì¥
    DROP TEMPORARY TABLE IF EXISTS optimal_team;
    CREATE TEMPORARY TABLE optimal_team (
        emp_id INT,
        emp_name VARCHAR(50),
        department VARCHAR(50),
        role VARCHAR(50),
        salary DECIMAL(10,2),
        availability_score DECIMAL(5,2) -- ê°€ìš©ì„± ì ìˆ˜ (ë†’ì„ìˆ˜ë¡ í”„ë¡œì íŠ¸ íˆ¬ì… ìš©ì´)
    );
    
    -- JSON ë°°ì—´ì˜ ì´ ê¸¸ì´ (í•„ìš”í•œ ì—­í• ì˜ ìˆ˜) ê³„ì‚°
    SET total_roles = JSON_LENGTH(required_roles);
    
    WHILE role_index < total_roles DO -- ê° ì—­í• ë³„ë¡œ ë°˜ë³µ
        -- JSONì—ì„œ ì—­í•  ì´ë¦„ê³¼ í•„ìš”í•œ ì¸ì› ìˆ˜ ì¶”ì¶œ
        SET role_name = JSON_UNQUOTE(JSON_EXTRACT(required_roles, CONCAT('$[', role_index, '].role')));
        SET role_count = JSON_EXTRACT(required_roles, CONCAT('$[', role_index, '].count'));
        
        -- ê° ì—­í• ì— ì í•©í•œ ì§ì› ì„ ë°œ (ê°€ìš©ì„± ì ìˆ˜ì™€ ê¸‰ì—¬ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì„ íƒ)
        INSERT INTO optimal_team
        SELECT 
            e.emp_id,
            e.name,
            e.department,
            role_name, -- í• ë‹¹ë  ì—­í•  ì´ë¦„
            e.salary,
            -- ê°€ìš©ì„± ì ìˆ˜ ê³„ì‚° (í˜„ì¬ í”„ë¡œì íŠ¸ ë¶€í•˜ ê³ ë ¤: 100ì—ì„œ í˜„ì¬ í• ë‹¹ë¥ ì„ ëº€ ê°’)
            100 - COALESCE(
                (SELECT SUM(pa.allocation_percent) 
                 FROM project_assignments pa 
                 WHERE pa.emp_id = e.emp_id 
                   AND pa.end_date >= CURDATE()), 0
            ) AS availability_score
        FROM employees e
        WHERE e.department = CASE -- ì—­í• ì— ë”°ë¼ íŠ¹ì • ë¶€ì„œì˜ ì§ì›ë§Œ ê³ ë ¤
                WHEN role_name LIKE '%Developer%' THEN 'ê°œë°œíŒ€'
                WHEN role_name LIKE '%Designer%' THEN 'ë””ìì¸íŒ€'
                WHEN role_name LIKE '%Marketing%' THEN 'ë§ˆì¼€íŒ…íŒ€'
                ELSE e.department -- íŠ¹ì • ë¶€ì„œê°€ ì•„ë‹ˆë©´ ëª¨ë“  ë¶€ì„œ ê³ ë ¤
            END
            AND NOT EXISTS ( -- ì´ë¯¸ í•´ë‹¹ í”„ë¡œì íŠ¸ì— í• ë‹¹ëœ ì§ì›ì€ ì œì™¸
                SELECT 1 FROM project_assignments pa2
                WHERE pa2.emp_id = e.emp_id 
                  AND pa2.project_id = project_id
            )
        ORDER BY availability_score DESC, e.salary ASC -- ê°€ìš©ì„± ë†’ì€ ìˆœ, ê¸‰ì—¬ ë‚®ì€ ìˆœìœ¼ë¡œ ì •ë ¬
        LIMIT role_count; -- í•„ìš”í•œ ì¸ì› ìˆ˜ë§Œí¼ë§Œ ì„ íƒ
        
        SET role_index = role_index + 1; -- ë‹¤ìŒ ì—­í• ë¡œ ì´ë™
    END WHILE;
    
    -- ìµœì¢… íŒ€ êµ¬ì„± ê²°ê³¼ ìš”ì•½ (ì¶œë ¥ ë§¤ê°œë³€ìˆ˜ì— ì €ì¥)
    SELECT GROUP_CONCAT(
        CONCAT(emp_name, '(', role, '-', department, ')')
        ORDER BY role, emp_name
        SEPARATOR ', '
    ) INTO team_composition
    FROM optimal_team;
    
    -- ìƒì„¸ ê²°ê³¼ ì¶œë ¥ (ì—­í• ë³„ í• ë‹¹ëœ ì¸ì›, ë©¤ë²„ ëª©ë¡, í‰ê·  ê¸‰ì—¬ ë“±)
    SELECT 
        role,
        COUNT(*) AS assigned_count,
        GROUP_CONCAT(emp_name ORDER BY availability_score DESC) AS team_members,
        AVG(salary) AS avg_role_salary,
        AVG(availability_score) AS avg_availability
    FROM optimal_team
    GROUP BY role;
    
    -- ì „ì²´ íŒ€ ë¹„ìš© ë° ê°€ìš©ì„± ìš”ì•½
    SELECT 
        COUNT(*) AS total_team_size,
        SUM(salary) AS total_monthly_cost,
        AVG(availability_score) AS avg_team_availability
    FROM optimal_team;
    
END //

DELIMITER ;

-- í”„ë¡œì‹œì € ì‚¬ìš© ì˜ˆì‹œ
SET @team_result = '';
SET @required_roles = '[
    {"role": "Lead Developer", "count": 1},
    {"role": "Frontend Developer", "count": 2},
    {"role": "UI Designer", "count": 1},
    {"role": "Marketing Specialist", "count": 1}
]';

CALL OptimizeProjectTeam(1, @required_roles, @team_result);
SELECT @team_result AS recommended_team;
```

---

## 5. íŠ¸ë¦¬ê±° (Trigger): ë°ì´í„° ë³€ê²½ ìë™í™”

íŠ¸ë¦¬ê±°(Trigger)ëŠ” íŠ¹ì • í…Œì´ë¸”ì—ì„œ `INSERT`, `UPDATE`, `DELETE`ì™€ ê°™ì€ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” SQL ë¬¸ ë˜ëŠ” í”„ë¡œì‹œì €ì…ë‹ˆë‹¤. ë°ì´í„° ë¬´ê²°ì„± ìœ ì§€, ìë™ ë¡œê¹…, ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê°•ì œ ë“±ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

### 5.1. ê¸°ë³¸ íŠ¸ë¦¬ê±° ìƒì„±: ìë™ ë¡œê¹…

íŠ¸ë¦¬ê±°ëŠ” `BEFORE` ë˜ëŠ” `AFTER` ì´ë²¤íŠ¸ ì‹œì ì— ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `OLD`ì™€ `NEW` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€ê²½ ì „/í›„ì˜ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
-- ê¸‰ì—¬ ë³€ê²½ ë¡œê·¸ í…Œì´ë¸” ìƒì„±
CREATE TABLE salary_change_log (
    log_id INT PRIMARY KEY AUTO_INCREMENT,
    emp_id INT,
    old_salary DECIMAL(10,2),
    new_salary DECIMAL(10,2),
    change_amount DECIMAL(10,2),
    change_percent DECIMAL(5,2),
    changed_by VARCHAR(50),
    change_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

DELIMITER //

-- ê¸‰ì—¬ ë³€ê²½ ìë™ ë¡œê·¸ íŠ¸ë¦¬ê±°
CREATE TRIGGER salary_change_audit
    AFTER UPDATE ON employees -- employees í…Œì´ë¸”ì˜ UPDATE ì´ë²¤íŠ¸ ë°œìƒ í›„
    FOR EACH ROW -- ë³€ê²½ë˜ëŠ” ê° í–‰ì— ëŒ€í•´ ì‹¤í–‰
BEGIN
    IF OLD.salary != NEW.salary THEN -- ê¸‰ì—¬ê°€ ì‹¤ì œë¡œ ë³€ê²½ë˜ì—ˆì„ ê²½ìš°
        INSERT INTO salary_change_log ( -- ë¡œê·¸ í…Œì´ë¸”ì— ë³€ê²½ ì´ë ¥ ê¸°ë¡
            emp_id, 
            old_salary, 
            new_salary, 
            change_amount,
            change_percent,
            changed_by
        ) VALUES (
            NEW.emp_id, -- ë³€ê²½ í›„ì˜ emp_id
            OLD.salary, -- ë³€ê²½ ì „ì˜ salary
            NEW.salary, -- ë³€ê²½ í›„ì˜ salary
            NEW.salary - OLD.salary, -- ë³€ê²½ëŸ‰
            ROUND((NEW.salary - OLD.salary) / OLD.salary * 100, 2), -- ë³€ê²½ë¥ 
            USER() -- í˜„ì¬ SQLì„ ì‹¤í–‰í•œ ì‚¬ìš©ì
        );
    END IF;
END //

-- ì§ì› ì‚­ì œ ë°©ì§€ íŠ¸ë¦¬ê±° (í”„ë¡œì íŠ¸ ì§„í–‰ ì¤‘ì¸ ê²½ìš°)
CREATE TRIGGER prevent_employee_deletion
    BEFORE DELETE ON employees -- employees í…Œì´ë¸”ì˜ DELETE ì´ë²¤íŠ¸ ë°œìƒ ì „
    FOR EACH ROW
BEGIN
    DECLARE project_count INT;
    
    -- ì‚­ì œí•˜ë ¤ëŠ” ì§ì›ì´ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•˜ê³  ìˆëŠ”ì§€ í™•ì¸
    SELECT COUNT(*) INTO project_count
    FROM project_assignments pa
    INNER JOIN projects p ON pa.project_id = p.project_id
    WHERE pa.emp_id = OLD.emp_id -- OLD.emp_idëŠ” ì‚­ì œë  í–‰ì˜ emp_id
      AND p.status = 'In Progress'
      AND pa.end_date >= CURDATE();
    
    IF project_count > 0 THEN -- ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ìˆë‹¤ë©´
        SIGNAL SQLSTATE '45000' -- ì‚¬ìš©ì ì •ì˜ ì—ëŸ¬ ë°œìƒ
        SET MESSAGE_TEXT = 'ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ìˆëŠ” ì§ì›ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    END IF;
END //

DELIMITER ;

-- íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸
UPDATE employees SET salary = salary * 1.1 WHERE emp_id = 1;
SELECT * FROM salary_change_log;

-- ì‚­ì œ ë°©ì§€ íŠ¸ë¦¬ê±° í…ŒìŠ¤íŠ¸ (ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ì— í• ë‹¹ëœ ì§ì› ì‚­ì œ ì‹œë„)
-- DELETE FROM employees WHERE emp_id = 1;
```

### 5.2. ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ íŠ¸ë¦¬ê±°: ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

íŠ¸ë¦¬ê±°ëŠ” ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì„ ê°•ì œí•˜ì—¬ ë°ì´í„°ì˜ ì¼ê´€ì„±ê³¼ ë¬´ê²°ì„±ì„ ìë™ìœ¼ë¡œ ìœ ì§€í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • ì¡°ê±´ì´ ì¶©ì¡±ë˜ì§€ ì•Šìœ¼ë©´ ë°ì´í„° ë³€ê²½ì„ ë§‰ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sql
DELIMITER //

-- í”„ë¡œì íŠ¸ í• ë‹¹ ê²€ì¦ íŠ¸ë¦¬ê±°
CREATE TRIGGER validate_project_assignment
    BEFORE INSERT ON project_assignments -- project_assignments í…Œì´ë¸”ì— INSERT ì´ë²¤íŠ¸ ë°œìƒ ì „
    FOR EACH ROW
BEGIN
    DECLARE emp_dept VARCHAR(50);
    DECLARE current_allocation DECIMAL(5,2);
    DECLARE project_status VARCHAR(20);
    
    -- ì§ì› ë¶€ì„œ í™•ì¸
    SELECT department INTO emp_dept
    FROM employees
    WHERE emp_id = NEW.emp_id; -- NEW.emp_idëŠ” ìƒˆë¡œ ì‚½ì…ë  í–‰ì˜ emp_id
    
    -- í˜„ì¬ í• ë‹¹ë¥  í™•ì¸ (í•´ë‹¹ ì§ì›ì˜ ëª¨ë“  í”„ë¡œì íŠ¸ í• ë‹¹ë¥  í•©ê³„)
    SELECT COALESCE(SUM(allocation_percent), 0) INTO current_allocation
    FROM project_assignments
    WHERE emp_id = NEW.emp_id
      AND end_date >= CURDATE(); -- í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ë§Œ ê³ ë ¤
    
    -- í”„ë¡œì íŠ¸ ìƒíƒœ í™•ì¸
    SELECT status INTO project_status
    FROM projects
    WHERE project_id = NEW.project_id;
    
    -- ê²€ì¦ ê·œì¹™ë“¤
    IF NEW.allocation_percent <= 0 OR NEW.allocation_percent > 100 THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'í• ë‹¹ë¥ ì€ 1-100% ë²”ìœ„ ë‚´ì—ì„œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.';
    END IF;
    
    IF current_allocation + NEW.allocation_percent > 150 THEN -- ì´ í• ë‹¹ë¥ ì´ 150%ë¥¼ ì´ˆê³¼í•˜ë©´ ì—ëŸ¬
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'ì´ í• ë‹¹ë¥ ì´ 150%ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    END IF;
    
    IF project_status = 'Completed' THEN -- ì™„ë£Œëœ í”„ë¡œì íŠ¸ì—ëŠ” í• ë‹¹ ë¶ˆê°€
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'ì™„ë£Œëœ í”„ë¡œì íŠ¸ì—ëŠ” ìƒˆë¡œìš´ ì¸ì›ì„ í• ë‹¹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    END IF;
    
    -- ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ìœ¼ë©´ ì•ˆë¨
    IF NEW.start_date > NEW.end_date THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    END IF;
END //

-- ë¶€ì„œ ì˜ˆì‚° ì´ˆê³¼ ë°©ì§€ íŠ¸ë¦¬ê±°
CREATE TRIGGER check_department_budget
    BEFORE UPDATE ON employees -- employees í…Œì´ë¸”ì˜ UPDATE ì´ë²¤íŠ¸ ë°œìƒ ì „
    FOR EACH ROW
BEGIN
    DECLARE dept_budget DECIMAL(15,2);
    DECLARE current_total_salary DECIMAL(15,2);
    DECLARE salary_increase DECIMAL(10,2);
    
    IF OLD.salary != NEW.salary THEN -- ê¸‰ì—¬ê°€ ë³€ê²½ë˜ì—ˆì„ ê²½ìš°ì—ë§Œ ê²€ì‚¬
        -- ë¶€ì„œ ì˜ˆì‚° ì¡°íšŒ
        SELECT budget INTO dept_budget
        FROM departments d
        WHERE d.dept_name = NEW.department;
        
        -- í˜„ì¬ ë¶€ì„œ ì´ ê¸‰ì—¬ (ì—°ë´‰ ê¸°ì¤€, ë³€ê²½ë  ì§ì›ì€ ì œì™¸í•˜ê³  ê³„ì‚°)
        SELECT COALESCE(SUM(salary * 12), 0) INTO current_total_salary
        FROM employees
        WHERE department = NEW.department
          AND emp_id != NEW.emp_id; -- í˜„ì¬ ì—…ë°ì´íŠ¸ë˜ëŠ” ì§ì›ì€ ì œì™¸
        
        -- ë³€ê²½ë  ê¸‰ì—¬ë¥¼ í¬í•¨í•œ ì´ ê¸‰ì—¬ê°€ ë¶€ì„œ ì˜ˆì‚°ì„ ì´ˆê³¼í•˜ëŠ”ì§€ í™•ì¸
        IF current_total_salary + (NEW.salary * 12) > dept_budget THEN
            SIGNAL SQLSTATE '45000' 
            SET MESSAGE_TEXT = CONCAT(
                'ë¶€ì„œ ì˜ˆì‚°ì„ ì´ˆê³¼í•©ë‹ˆë‹¤. í˜„ì¬ ì‚¬ìš©: ',
                FORMAT(current_total_salary + (NEW.salary * 12), 0),
                ', ì˜ˆì‚°: ',
                FORMAT(dept_budget, 0)
            );
        END IF;
    END IF;
END //

DELIMITER ;
```

---

## 6. ì‹¤ë¬´ ì‹œë‚˜ë¦¬ì˜¤ í†µí•©

### 6.1. ì‹œë‚˜ë¦¬ì˜¤ 1: ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ ì™„ì„±

#### ğŸ¢ ì¢…í•© ì¸ì‚¬ ê´€ë¦¬ ì¿¼ë¦¬
```sql
-- ì¸ì‚¬ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ í†µí•© ë·°
WITH employee_analytics AS (
    SELECT 
        e.emp_id,
        e.name,
        e.department,
        e.salary,
        e.hire_date,
        GetYearsOfService(e.hire_date) AS years_worked, -- ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ í™œìš©
        CalculateEmployeeScore(e.emp_id, e.salary, e.hire_date, e.department) AS performance_score, -- ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ í™œìš©
        -- í˜„ì¬ í”„ë¡œì íŠ¸ ì°¸ì—¬ í˜„í™©
        (SELECT COUNT(*) FROM project_assignments pa WHERE pa.emp_id = e.emp_id) AS total_projects,
        (SELECT COUNT(*) FROM project_assignments pa 
         INNER JOIN projects p ON pa.project_id = p.project_id
         WHERE pa.emp_id = e.emp_id AND p.status = 'In Progress') AS active_projects,
        (SELECT COALESCE(SUM(pa.allocation_percent), 0) FROM project_assignments pa 
         INNER JOIN projects p ON pa.project_id = p.project_id
         WHERE pa.emp_id = e.emp_id AND pa.end_date >= CURDATE()) AS current_allocation,
        -- ê¸‰ì—¬ ë³€ë™ ì´ë ¥
        (SELECT COUNT(*) FROM salary_history sh WHERE sh.emp_id = e.emp_id) AS salary_changes,
        (SELECT MAX(sh.change_date) FROM salary_history sh WHERE sh.emp_id = e.emp_id) AS last_salary_change
    FROM employees e
    WHERE e.salary IS NOT NULL
),
department_benchmarks AS (
    SELECT 
        department,
        AVG(salary) AS dept_avg_salary,
        AVG(performance_score) AS dept_avg_score,
        COUNT(*) AS dept_size
    FROM employee_analytics
    GROUP BY department
)
SELECT 
    ea.name,
    ea.department,
    ea.salary,
    FormatKoreanNumber(ea.salary) AS salary_formatted, -- ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ í™œìš©
    ea.years_worked,
    ea.performance_score,
    GetSalaryGrade(ea.salary) AS salary_grade, -- ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ í™œìš©
    -- ë¶€ì„œ ë‚´ ìƒëŒ€ì  ìœ„ì¹˜
    RANK() OVER (PARTITION BY ea.department ORDER BY ea.salary DESC) AS dept_salary_rank,
    RANK() OVER (PARTITION BY ea.department ORDER BY ea.performance_score DESC) AS dept_score_rank,
    -- ì„±ê³¼ ëŒ€ë¹„ ê¸‰ì—¬ ì ì •ì„±
    CASE 
        WHEN ea.salary > db.dept_avg_salary * 1.2 AND ea.performance_score < db.dept_avg_score * 0.8 THEN 'ê³¼ë‹¤ì§€ê¸‰'
        WHEN ea.salary < db.dept_avg_salary * 0.8 AND ea.performance_score > db.dept_avg_score * 1.2 THEN 'ì €í‰ê°€'
        WHEN ea.salary >= db.dept_avg_salary * 1.1 AND ea.performance_score >= db.dept_avg_score * 1.1 THEN 'ìš°ìˆ˜ë³´ìƒ'
        ELSE 'ì ì •'
    END AS compensation_assessment,
    -- ì—…ë¬´ ë¶€í•˜ ìƒíƒœ
    CASE 
        WHEN ea.current_allocation > 120 THEN 'ê³¼ë¶€í•˜'
        WHEN ea.current_allocation > 80 THEN 'ì ì •'
        WHEN ea.current_allocation > 0 THEN 'ì—¬ìœ '
        ELSE 'ë¯¸ë°°ì •'
    END AS workload_status,
    -- ìŠ¹ì§„/ì¡°ì¹˜ ê¶Œê³ 
    CASE 
        WHEN ea.performance_score >= 80 AND ea.years_worked >= 2 THEN 'ìŠ¹ì§„ ê²€í† '
        WHEN ea.performance_score < 40 AND ea.years_worked >= 1 THEN 'ê°œì„  í•„ìš”'
        WHEN ea.current_allocation = 0 AND ea.years_worked >= 0.5 THEN 'í”„ë¡œì íŠ¸ ë°°ì • í•„ìš”'
        WHEN ea.salary < db.dept_avg_salary * 0.9 AND ea.performance_score >= db.dept_avg_score THEN 'ê¸‰ì—¬ ì¡°ì • ê²€í† '
        ELSE 'í˜„ìƒ ìœ ì§€'
    END AS hr_recommendation
FROM employee_analytics ea
INNER JOIN department_benchmarks db ON ea.department = db.department
ORDER BY ea.department, ea.performance_score DESC;
```

### 6.2. ì‹œë‚˜ë¦¬ì˜¤ 2: í”„ë¡œì íŠ¸ í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”

#### ğŸ“Š í”„ë¡œì íŠ¸ ë¦¬ì†ŒìŠ¤ ë¶„ì„ ë° ì¬ë°°ì¹˜
```sql
-- í”„ë¡œì íŠ¸ ë¦¬ì†ŒìŠ¤ ìµœì í™” ë¶„ì„
WITH project_resource_summary AS (
    SELECT 
        p.project_id,
        p.project_name,
        p.status,
        p.budget,
        p.start_date,
        p.end_date,
        COUNT(pa.emp_id) AS team_size,
        SUM(pa.allocation_percent) AS total_allocation,
        AVG(e.salary) AS avg_team_salary,
        SUM(e.salary * pa.allocation_percent / 100) AS monthly_cost,
        -- ì˜ˆìƒ ì´ ë¹„ìš©
        SUM(e.salary * pa.allocation_percent / 100) * 
        GREATEST(1, DATEDIFF(GREATEST(p.end_date, CURDATE()), LEAST(p.start_date, CURDATE())) / 30) AS estimated_total_cost,
        -- íŒ€ êµ¬ì„± ë‹¤ì–‘ì„±
        COUNT(DISTINCT e.department) AS dept_diversity,
        GROUP_CONCAT(DISTINCT pa.role) AS roles_covered
    FROM projects p
    LEFT JOIN project_assignments pa ON p.project_id = pa.project_id
    LEFT JOIN employees e ON pa.emp_id = e.emp_id
    GROUP BY p.project_id, p.project_name, p.status, p.budget, p.start_date, p.end_date
),
employee_utilization AS (
    SELECT 
        e.emp_id,
        e.name,
        e.department,
        e.salary,
        COALESCE(SUM(pa.allocation_percent), 0) AS total_allocation,
        COUNT(pa.project_id) AS active_projects,
        GROUP_CONCAT(p.project_name) AS assigned_projects,
        -- ê°€ìš© ì—­ëŸ‰
        100 - COALESCE(SUM(pa.allocation_percent), 0) AS available_capacity
    FROM employees e
    LEFT JOIN project_assignments pa ON e.emp_id = pa.emp_id 
        AND pa.end_date >= CURDATE()
    LEFT JOIN projects p ON pa.project_id = p.project_id 
        AND p.status IN ('Planning', 'In Progress')
    GROUP BY e.emp_id, e.name, e.department, e.salary
)
-- í”„ë¡œì íŠ¸ë³„ ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„± ë¶„ì„
SELECT 
    prs.project_name,
    prs.status,
    prs.team_size,
    prs.total_allocation,
    ROUND(prs.avg_team_salary, 0) AS avg_team_salary,
    ROUND(prs.monthly_cost, 0) AS monthly_cost,
    ROUND(prs.estimated_total_cost, 0) AS estimated_total_cost,
    ROUND(prs.estimated_total_cost / prs.budget * 100, 2) AS cost_budget_ratio,
    prs.dept_diversity,
    -- ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„± ì§€í‘œ
    ROUND(prs.budget / prs.team_size / DATEDIFF(prs.end_date, prs.start_date), 0) AS daily_budget_per_person,
    -- ê¶Œê³ ì‚¬í•­
    CASE 
        WHEN prs.total_allocation > 200 THEN 'CRITICAL: ë¦¬ì†ŒìŠ¤ ê³¼ë¶€í•˜ - ì¦‰ì‹œ ì¸ë ¥ ì¶©ì› í•„ìš”'
        WHEN prs.total_allocation < 100 AND prs.team_size > 1 THEN 'WARNING: ë¦¬ì†ŒìŠ¤ ë¶€ì¡± - ì¶”ê°€ ë°°ì • ê²€í† '
        WHEN prs.estimated_total_cost > prs.budget * 1.3 THEN 'ALERT: ì˜ˆì‚° ì´ˆê³¼ ìœ„í—˜ - ë¹„ìš© ì ˆê° ë°©ì•ˆ í•„ìš”'
        WHEN prs.dept_diversity < 2 AND prs.team_size > 3 THEN 'NOTICE: íŒ€ ë‹¤ì–‘ì„± ë¶€ì¡± - íƒ€ ë¶€ì„œ ì¸ë ¥ ê³ ë ¤'
        ELSE 'OK: ì ì • ìˆ˜ì¤€'
    END AS optimization_recommendation,
    -- ê°œì„  ê°€ëŠ¥ ì ìˆ˜ (ë‚®ì„ìˆ˜ë¡ ê°œì„  í•„ìš”)
    CASE 
        WHEN prs.total_allocation BETWEEN 80 AND 120 THEN 30
        WHEN prs.total_allocation BETWEEN 60 AND 140 THEN 20
        ELSE 10
    END +
    CASE 
        WHEN prs.estimated_total_cost <= prs.budget THEN 30
        WHEN prs.estimated_total_cost <= prs.budget * 1.1 THEN 20
        ELSE 10
    END +
    CASE 
        WHEN prs.dept_diversity >= 3 THEN 20
        WHEN prs.dept_diversity >= 2 THEN 15
        ELSE 10
    END AS efficiency_score
FROM project_resource_summary prs
WHERE prs.status IN ('Planning', 'In Progress')
ORDER BY efficiency_score ASC, cost_budget_ratio DESC;

-- ê°€ìš© ì¸ë ¥ í˜„í™©
SELECT 
    eu.department,
    COUNT(*) AS total_employees,
    COUNT(CASE WHEN eu.available_capacity > 50 THEN 1 END) AS highly_available,
    COUNT(CASE WHEN eu.available_capacity BETWEEN 20 AND 50 THEN 1 END) AS moderately_available,
    COUNT(CASE WHEN eu.available_capacity < 20 THEN 1 END) AS low_availability,
    ROUND(AVG(eu.available_capacity), 1) AS avg_available_capacity,
    GROUP_CONCAT(
        CASE WHEN eu.available_capacity > 50 
        THEN CONCAT(eu.name, '(', eu.available_capacity, '%)')
        END
    ) AS high_availability_members
FROM employee_utilization eu
GROUP BY eu.department
ORDER BY avg_available_capacity DESC;
```

---

## 7. ë§ˆë¬´ë¦¬: í•µì‹¬ ì •ë¦¬

### 7.1.í•„ìˆ˜ ì•”ê¸° í•¨ìˆ˜

#### ì„œë¸Œì¿¼ë¦¬ íŒ¨í„´
```sql
-- ìƒê´€ ì„œë¸Œì¿¼ë¦¬
WHERE column > (SELECT AVG(column) FROM table WHERE condition = outer.condition)

-- EXISTS íŒ¨í„´
WHERE EXISTS (SELECT 1 FROM table WHERE condition)

-- CTE íŒ¨í„´
WITH cte_name AS (SELECT ...) SELECT ... FROM cte_name
```

#### CASEë¬¸ íŒ¨í„´
```sql
-- ë‹¨ìˆœ CASE
CASE column WHEN value1 THEN result1 WHEN value2 THEN result2 ELSE default END

-- ê²€ìƒ‰ CASE
CASE WHEN condition1 THEN result1 WHEN condition2 THEN result2 ELSE default END
```

#### í•¨ìˆ˜/í”„ë¡œì‹œì € ê¸°ë³¸ êµ¬ì¡°
```sql
-- í•¨ìˆ˜
CREATE FUNCTION function_name(param TYPE) RETURNS TYPE
BEGIN
    DECLARE variable TYPE;
    -- ë¡œì§
    RETURN value;
END

-- í”„ë¡œì‹œì €
CREATE PROCEDURE procedure_name(IN param TYPE, OUT result TYPE)
BEGIN
    -- ë¡œì§
END
```

### 7.2. ì‹¤ë¬´ íŒ

1. **ì„œë¸Œì¿¼ë¦¬ ìµœì í™”**: EXISTSê°€ INë³´ë‹¤ ëŒ€ìš©ëŸ‰ ë°ì´í„°ì—ì„œ ë” íš¨ìœ¨ì 
2. **CTE í™œìš©**: ë³µì¡í•œ ì¿¼ë¦¬ë¥¼ ë‹¨ê³„ë³„ë¡œ ë¶„í•´í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
3. **CASEë¬¸**: í”¼ë²— í…Œì´ë¸” ìƒì„±ì´ë‚˜ ë³µì¡í•œ ë¶„ë¥˜ ë¡œì§ì— í™œìš©
4. **í•¨ìˆ˜**: ìì£¼ ì‚¬ìš©ë˜ëŠ” ê³„ì‚° ë¡œì§ì„ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ëª¨ë“ˆí™”
5. **í”„ë¡œì‹œì €**: ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ì²˜ë¦¬
6. **íŠ¸ë¦¬ê±°**: ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ê³¼ ìë™ ë¡œê¹…ì— í™œìš©

### 7.3. ì£¼ì˜ì‚¬í•­

- íŠ¸ë¦¬ê±°ëŠ” ì„±ëŠ¥ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©
- ë³µì¡í•œ í”„ë¡œì‹œì €ëŠ” ë””ë²„ê¹…ì´ ì–´ë ¤ìš°ë¯€ë¡œ ë‹¨ìœ„ë³„ë¡œ í…ŒìŠ¤íŠ¸
- CTEëŠ” MySQL 8.0 ì´ìƒì—ì„œë§Œ ì§€ì›
---
[â®ï¸ ì´ì „ ë¬¸ì„œ](./0519_SQLì •ë¦¬.md) | [ë‹¤ìŒ ë¬¸ì„œ â­ï¸](./0521_SQLì •ë¦¬.md)